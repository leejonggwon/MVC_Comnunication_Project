<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.spring.mapper.BoardMapper">

    <!-- SQL문장 프로그래밍  -->
	<sql id="search">
		<if test="type=='writer'">
			WHERE WRITER LIKE CONCAT('%', #{keyword},'%')
		</if>
		<if test="type=='title'">
			WHERE TITLE LIKE CONCAT('%', #{keyword},'%')
		</if>
		<if test="type=='content'">
			WHERE CONTENT LIKE CONCAT('%', #{keyword},'%')
		</if>
	</sql>

	<select id="getList" parameterType="kr.spring.entity.Criteria" resultType="kr.spring.entity.Board">
		SELECT * FROM CM_BOARD
		<include refid="search"/>
		ORDER BY BOARDGROUP DESC, BOARDSEQUENCE ASC
		LIMIT #{pageStart}, #{perPageNum}
	</select>
	<!--  LIMIT 20, 10 : 20번째 글부터 10개 가져오기 -->
	
	
	<insert id="insert" parameterType="kr.spring.entity.Board">
		INSERT INTO CM_BOARD(IDX, MEMID, TITLE, CONTENT, WRITER, IMGPATH, BOARDGROUP, BOARDSEQUENCE, BOARDLEVEL, BOARDAVAILABLE)
		SELECT IFNULL(MAX(IDX) + 1, 1) , #{memID}, #{title}, #{content}, #{writer}, #{imgpath}, IFNULL(MAX(IDX) + 1, 1), 0, 0, 1   
		FROM CM_BOARD                   
	</insert>
	<!-- 날짜와(NOW) 조회수(0)는 빼고 넣어준다  -->
	<!-- VALUES가 없는 이유: SELECT가 그 자리를 대신해서, 새 글 번호를 계산하고 나머지 값도 함께 넣어주기 때문 -->
	<!-- boardGroup도 IDX와 쿼리문이 동일하다 -->
	<!-- BOARDSEQUENCE, BOARDLEVEL 본 글이므로 0 이다 -->
	<!-- BOARDAVAILABLE는 삭제 안되어 있으므로 1 -->
	



	<!-- 동적쿼리기술 : IDX, BOARDGROUP을 처음부터 SELECT 해서 결과를 INSERT에 넣는다 -->
	<!-- selectKey: INSERT 전에 DB에서 사용할 키 값을 먼저 조회해서 그 값을 INSERT에 넣어주는 역할 -->
	<!--  keyProperty는 board안에 있는 필드명과 동일해야한다 -->
	<!--  order="BEFORE": INSERT문장 이전에 selectKey 실행 -->	
	<!-- SELECT한 값이 → keyProperty 에 받아서 → resultType에 반환되고 → parameterType 으로 들어간다 -->
	
	<insert id="insertSelectKey" parameterType="kr.spring.entity.Board">
		<selectKey keyProperty="idx,boardGroup" resultType="kr.spring.entity.Board" order="BEFORE"> 
			SELECT IFNULL(MAX(IDX) + 1, 1) as idx,
				   IFNULL(MAX(BOARDGROUP) + 1, 1) as boardGroup
				   FROM CM_BOARD 	
		</selectKey>
		INSERT INTO CM_BOARD(IDX, MEMID, TITLE, CONTENT, WRITER, IMGPATH, BOARDGROUP, BOARDSEQUENCE, BOARDLEVEL, BOARDAVAILABLE)
		VALUES(#{idx}, #{memID}, #{title}, #{content}, #{writer}, #{imgpath}, #{boardGroup}, 0, 0, 1)
	</insert>
	
	
	
	
	<!-- 게시글상세보기  -->
	<select id="read" parameterType="int" resultType="kr.spring.entity.Board">
		SELECT * FROM CM_BOARD WHERE IDX = #{idx}
	</select>
	
	<!-- 게시글수정 -->
	<update id="update" parameterType="kr.spring.entity.Board">
		UPDATE CM_BOARD 
		SET TITLE = #{title}, CONTENT = #{content}
		WHERE IDX = #{idx}
	</update>
	
	<!-- 게시글삭제 -->
	<delete id="delete" parameterType="int">
		UPDATE CM_BOARD
		SET BOARDAVAILABLE = 0
		WHERE IDX = #{idx}
	</delete>
	
	<!-- BOARDSEQUENCE + 1 기능 -->
	<!-- parent 부모글 : boardSequence=0, boardLevel=0, boardAvailable=1 -->
	<update id="replySeqUpdate" parameterType="kr.spring.entity.Board"  >
		UPDATE CM_BOARD
		SET BOARDSEQUENCE = BOARDSEQUENCE + 1
		WHERE BOARDGROUP = #{boardGroup}
		AND BOARDSEQUENCE > #{boardSequence} 
	</update>
	
	
	<!-- 댓글 등록기능 -->
	<!-- IFNULL(MAX(IDX) + 1, 1) as idx : 새로 들어올 댓글 의 IDX 값을 자동으로 계산해서 하나 증가시켜 주는 역할 -->
	<insert id="replyInsert" parameterType="kr.spring.entity.Board">
		<selectKey keyProperty="idx" resultType="kr.spring.entity.Board" order="BEFORE"> 
			SELECT IFNULL(MAX(IDX) + 1, 1) as idx
				   FROM CM_BOARD 	
		</selectKey>
		INSERT INTO CM_BOARD(IDX, MEMID, TITLE, CONTENT, WRITER, IMGPATH, BOARDGROUP, BOARDSEQUENCE, BOARDLEVEL, BOARDAVAILABLE)
		VALUES(#{idx}, #{memID}, #{title}, #{content}, #{writer}, #{imgpath}, 
		#{boardGroup}, #{boardSequence}, #{boardLevel}, 1)
	</insert>
	
	<!-- 총게시글수 -->
	<!-- 검색결과에 따라 총게시글수가 변경된다 -->
	<select id="totalCount" resultType="int" parameterType="kr.spring.entity.Criteria" >
		SELECT COUNT(*) FROM CM_BOARD 
		<include refid="search"/>
	</select>
	
	<!-- 게시판 조회수 -->
	<update id="boardCount" parameterType="int">
		UPDATE CM_BOARD SET COUNT = COUNT + 1 WHERE IDX = #{idx}
	</update>
	
</mapper>




















